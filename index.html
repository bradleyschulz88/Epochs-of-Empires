<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>War Game</title>
  <style>
    body { margin: 0; font-family: Arial; background-color: #f0f0f0; color: #333; }
    #gameContainer { display: flex; margin: 20px; gap: 20px; }
    #canvasContainer { position: relative; }
    #gameCanvas { border: 1px solid black; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    #minimap { position: absolute; top: 10px; right: 10px; border: 1px solid black; background: rgba(0,0,0,0.5); }
    #ui { width: 350px; padding: 15px; background: #fff; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    button { margin: 5px; padding: 10px; width: 100%; background: #4a5568; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
    button:hover { background: #2d3748; }
    button:disabled { background: #cbd5e0; cursor: not-allowed; }
    select { margin: 5px; padding: 8px; width: 100%; border-radius: 4px; border: 1px solid #cbd5e0; }
    .unit-buttons, .building-buttons, .research-buttons { max-height: 200px; overflow-y: auto; padding: 5px; }
    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; background: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 10px; }
    .unit-category { margin: 10px 0; border-bottom: 1px solid #edf2f7; padding-bottom: 8px; }
    .unit-category h4 { margin: 5px 0; color: #4a5568; }
    #tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 4px; display: none; max-width: 300px; z-index: 100; }
    #currentStats { margin-top: 10px; padding: 10px; border: 1px solid #edf2f7; border-radius: 4px; }
    .tech-tree { margin-top: 10px; display: none; }
    .tech-tree-toggle { text-align: center; cursor: pointer; margin: 5px; color: #4a5568; }
    .tab-container { display: flex; }
    .tab { padding: 10px 0; flex: 1; text-align: center; cursor: pointer; background: #edf2f7; }
    .tab.active { background: #4a5568; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .resource-container { display: flex; justify-content: space-between; background: #edf2f7; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
    .resource { display: flex; flex-direction: column; align-items: center; }
    .resource-icon { font-size: 18px; margin-bottom: 5px; }
    .notification { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 5px; max-width: 300px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .progress-container { width: 100%; background: #edf2f7; border-radius: 4px; margin: 10px 0; }
    .progress-bar { height: 10px; border-radius: 4px; background: #4a5568; width: 0%; transition: width 0.3s; }
    .progress-label { text-align: center; font-size: 12px; }
  </style>
</head>
<body>
  <div id="gameContainer">
    <div id="canvasContainer">
      <canvas id="gameCanvas" width="800" height="600"></canvas>
      <canvas id="minimap" width="150" height="150"></canvas>
    </div>
    <div id="ui">
      <h2>Player <span id="currentPlayer">1</span> - <span id="currentAge">Stone Age</span></h2>
      
      <div class="resource-container">
        <div class="resource">
          <div class="resource-icon">üí∞</div>
          <div><span id="gold">100</span></div>
          <div>Gold</div>
        </div>
        <div class="resource">
          <div class="resource-icon">üõ¢Ô∏è</div>
          <div><span id="oil">50</span></div>
          <div>Oil</div>
        </div>
        <div class="resource">
          <div class="resource-icon">üë•</div>
          <div><span id="manpower">100</span></div>
          <div>Manpower</div>
        </div>
      </div>
      
      <div id="currentStats">
        <p>Weather: <span id="weather">Clear</span> | Diplomacy: <span id="diplomacyStatus">Neutral</span></p>
        <p>Turn: <span id="turnCounter">1</span> | Year: <span id="yearCounter">3000 BCE</span></p>
      </div>
      
      <div class="tab-container">
        <div class="tab active" data-tab="actions">Actions</div>
        <div class="tab" data-tab="research">Research</div>
        <div class="tab" data-tab="units">Units</div>
        <div class="tab" data-tab="diplomacy">Diplomacy</div>
      </div>
      
      <div class="tab-content active" id="actions-tab">
        <button onclick="endTurn()">End Turn</button>
        <button onclick="advanceAge()" id="advanceAgeBtn">Advance Age</button>
        <div class="progress-container">
          <div class="progress-bar" id="ageProgressBar"></div>
          <div class="progress-label" id="ageProgressLabel">Age Progress: 0%</div>
        </div>
        <h3>Construct Building</h3>
        <div class="building-buttons">
          <button onclick="startBuilding('barracks')">Barracks (50 Gold, 10 Manpower)</button>
          <button onclick="startBuilding('tank_yard')">Tank Yard (60 Gold, 20 Oil)</button>
          <button onclick="startBuilding('ship_dock')">Ship Dock (70 Gold, 20 Oil)</button>
          <button onclick="startBuilding('research_center')">Research Center (80 Gold, 15 Manpower)</button>
          <button onclick="startBuilding('market')">Market (40 Gold)</button>
        </div>
      </div>
      
      <div class="tab-content" id="research-tab">
        <h3>Research Technology</h3>
        <div class="tech-tree-toggle" onclick="toggleTechTree()">Show/Hide Tech Tree</div>
        <div class="tech-tree" id="techTree"></div>
        <div class="research-buttons" id="researchButtons"></div>
        <div class="progress-container">
          <div class="progress-bar" id="researchProgressBar"></div>
          <div class="progress-label" id="researchProgressLabel">Research Progress: 0%</div>
        </div>
      </div>
      
      <div class="tab-content" id="units-tab">
        <h3>Produce Unit</h3>
        <div class="unit-buttons" id="unitButtons"></div>
      </div>
      
      <div class="tab-content" id="diplomacy-tab">
        <h3>Diplomacy Actions</h3>
        <select id="diplomacyAction" onchange="handleDiplomacy()">
          <option value="">Select Action</option>
          <option value="ally">Form Alliance</option>
          <option value="trade">Trade Resources</option>
          <option value="war">Declare War</option>
          <option value="peace">Negotiate Peace</option>
        </select>
        
        <h3>Game Settings</h3>
        <select id="aiDifficulty" onchange="setAIDifficulty()">
          <option value="easy">AI: Easy</option>
          <option value="medium">AI: Medium</option>
          <option value="hard">AI: Hard</option>
        </select>
        <button onclick="toggleFogOfWar()">Toggle Fog of War</button>
      </div>
    </div>
  </div>
  
  <div id="tooltip"></div>
  <div id="loading">Loading Game...</div>
  <div id="notification" class="notification"></div>
  
  <script>
    // Game constants
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const minimap = document.getElementById('minimap');
    const minimapCtx = minimap.getContext('2d');
    const tooltip = document.getElementById('tooltip');
    
    const tileSize = 40;
    const mapSize = 30;
    const minimapTileSize = minimap.width / mapSize;
    const ages = ['Stone Age', 'Bronze Age', 'Iron Age', 'Medieval Age', 'Renaissance Age', 'Industrial Age', 'Modern Age'];
    const historicalYears = ['3000 BCE', '2000 BCE', '1000 BCE', '500 CE', '1400 CE', '1800 CE', '1950 CE'];
    
    // Game settings
    let fogOfWarEnabled = true;
    let gameStarted = false;
    let currentTab = 'actions';
    let mouseX = 0, mouseY = 0;
    let cameraOffsetX = 0, cameraOffsetY = 0;
    let isDragging = false;
    let dragStartX = 0, dragStartY = 0;
    let selectedUnit = null;
    let selectedBuildingType = null;
    
    // Define terrain types
    const terrainTypes = {
      land: { color: '#8BC34A', moveCost: 1, description: 'Basic land terrain' },
      water: { color: '#2196F3', moveCost: 2, description: 'Water - only naval units can cross' },
      mountain: { color: '#9E9E9E', moveCost: 3, description: 'Mountains - difficult to cross, defense bonus' },
      forest: { color: '#33691E', moveCost: 2, description: 'Forest - provides cover and resources' },
      desert: { color: '#FFC107', moveCost: 2, description: 'Desert - difficult to traverse' },
      hills: { color: '#795548', moveCost: 2, description: 'Hills - provide defensive advantage' },
      gold: { color: '#FFD700', moveCost: 1, description: 'Gold deposit - provides gold income' },
      oil: { color: '#607D8B', moveCost: 1, description: 'Oil deposit - provides oil for advanced units' }
    };
    
    // Technology tree
    const technologies = {
      'Stone Age': {
        'Basic Tools': { 
          cost: 30, 
          prerequisites: [], 
          unlocks: ['clubman', 'forager'],
          description: 'First basic tools for hunting and gathering'
        },
        'Fire Making': { 
          cost: 40, 
          prerequisites: ['Basic Tools'], 
          unlocks: ['camp'],
          description: 'Control of fire allows cooking and better weapons' 
        },
        'Stone Weapons': { 
          cost: 50, 
          prerequisites: ['Basic Tools'], 
          unlocks: ['spearthrower'],
          description: 'Advanced stone weapons for hunting and combat'
        }
      },
      'Bronze Age': {
        'Bronze Working': { 
          cost: 60, 
          prerequisites: [], 
          unlocks: ['spearman', 'slinger'],
          description: 'First metal tools and weapons' 
        },
        'Wheel': { 
          cost: 70, 
          prerequisites: ['Bronze Working'], 
          unlocks: ['chariot'],
          description: 'Invention of the wheel enables faster movement' 
        },
        'Early Sailing': { 
          cost: 80, 
          prerequisites: ['Bronze Working'], 
          unlocks: ['trireme'],
          description: 'First sailing vessels for crossing water' 
        }
      },
      'Iron Age': {
        'Iron Working': { 
          cost: 90, 
          prerequisites: [], 
          unlocks: ['swordsman', 'axeman'],
          description: 'Stronger metal weapons and tools' 
        },
        'Cavalry': { 
          cost: 100, 
          prerequisites: ['Iron Working'], 
          unlocks: ['horseman'],
          description: 'Mounted warriors for faster attacks' 
        },
        'Engineering': { 
          cost: 110, 
          prerequisites: ['Iron Working'], 
          unlocks: ['catapult'],
          description: 'Early siege weapons and fortifications' 
        }
      }
    };
    
    // Unit types
    const unitTypes = {
      // Stone Age
      forager: { attack: 1, defense: 1, move: 2, vision: 3, cost: { gold: 10, manpower: 5 }, type: 'land' },
      clubman: { attack: 3, defense: 2, move: 1, vision: 1, cost: { gold: 15, manpower: 10 }, type: 'land' },
      spearthrower: { attack: 4, defense: 1, move: 1, vision: 2, cost: { gold: 20, manpower: 10 }, type: 'land' },
      
      // Bronze Age
      spearman: { attack: 5, defense: 4, move: 1, vision: 1, cost: { gold: 20, manpower: 15 }, type: 'land' },
      slinger: { attack: 4, defense: 2, move: 1, vision: 2, cost: { gold: 25, manpower: 10 }, type: 'land' },
      chariot: { attack: 6, defense: 3, move: 3, vision: 2, cost: { gold: 30, manpower: 15 }, type: 'land' },
      trireme: { attack: 5, defense: 3, move: 2, vision: 3, cost: { gold: 40, manpower: 20, oil: 5 }, type: 'sea' },
      
      // Iron Age
      swordsman: { attack: 8, defense: 6, move: 1, vision: 1, cost: { gold: 30, manpower: 20 }, type: 'land' },
      axeman: { attack: 10, defense: 4, move: 1, vision: 1, cost: { gold: 35, manpower: 20 }, type: 'land' },
      horseman: { attack: 8, defense: 4, move: 3, vision: 2, cost: { gold: 40, manpower: 20 }, type: 'land' },
      catapult: { attack: 12, defense: 2, move: 1, vision: 2, cost: { gold: 50, manpower: 25, oil: 10 }, type: 'land' }
    };
    
    // Building types
    const buildingTypes = {
      hq: { defense: 10, vision: 3, production: { gold: 5, manpower: 5 }, cost: { gold: 0 } },
      barracks: { defense: 5, vision: 1, production: { manpower: 10 }, cost: { gold: 50, manpower: 10 } },
      market: { defense: 3, vision: 1, production: { gold: 15 }, cost: { gold: 40 } },
      research_center: { defense: 4, vision: 2, production: { research: 5 }, cost: { gold: 80, manpower: 15 } },
      tank_yard: { defense: 6, vision: 1, production: { oil: 5 }, cost: { gold: 60, oil: 20 } },
      ship_dock: { defense: 5, vision: 2, production: {}, cost: { gold: 70, oil: 20 } }
    };
    
    // Game state
    let gameState = {
      currentPlayer: 1,
      turn: 1,
      weather: 'Clear',
      players: [
        {
          id: 1,
          name: "Player",
          color: "#4299E1",
          resources: { gold: 100, manpower: 100, oil: 50 },
          units: [],
          buildings: [],
          technologies: [],
          researchProgress: 0,
          currentResearch: null,
          age: "Stone Age",
          ageProgress: 0,
          unlockedUnits: ["forager"],
          diplomacy: { status: "Neutral", ally: false }
        },
        {
          id: 2,
          name: "AI",
          color: "#F56565",
          resources: { gold: 100, manpower: 100, oil: 50 },
          units: [],
          buildings: [],
          technologies: [],
          researchProgress: 0,
          currentResearch: null,
          age: "Stone Age",
          ageProgress: 0,
          unlockedUnits: ["forager"],
          diplomacy: { status: "Neutral", ally: false },
          isAI: true
        }
      ],
      map: []
    };
    
    // Init function to be called when page loads
    window.onload = function() {
      init();
    };
    
    function init() {
      generateMap();
      setupEventListeners();
      updateResourceDisplay();
      updateUnitButtons();
      updateResearchButtons();
      render();
      
      document.getElementById('loading').style.display = 'none';
      gameStarted = true;
    }
    
    // Generate a procedural map with varied terrain
    function generateMap() {
      gameState.map = [];
      
      // Generate base terrain
      for (let y = 0; y < mapSize; y++) {
        const row = [];
        for (let x = 0; x < mapSize; x++) {
          // Create more varied terrain with better generation
          let terrainType = 'land';
          
          // Add water bodies
          const centerDist = Math.sqrt(Math.pow(x - mapSize/2, 2) + Math.pow(y - mapSize/2, 2));
          if (Math.random() < 0.25 || (centerDist > mapSize/2.5 && Math.random() < 0.6)) {
            terrainType = 'water';
          }
          
          // Add other terrain types
          if (terrainType === 'land') {
            const r = Math.random();
            if (r < 0.1) {
              terrainType = 'mountain';
            } else if (r < 0.25) {
              terrainType = 'hills';
            } else if (r < 0.45) {
              terrainType = 'forest';
            } else if (r < 0.5) {
              terrainType = 'desert';
            }
          }
          
          // Add resources
          if (terrainType === 'desert' && Math.random() < 0.2) {
            terrainType = 'oil';
          } else if ((terrainType === 'mountain' || terrainType === 'hills') && Math.random() < 0.15) {
            terrainType = 'gold';
          }
          
          row.push({ 
            type: terrainType, 
            x: x, 
            y: y, 
            unit: null, 
            building: null,
            discovered: [false, false]
          });
        }
        gameState.map.push(row);
      }
      
      // Place starting HQs for both players
      const player1X = 3;
      const player1Y = 3;
      const player2X = mapSize - 4;
      const player2Y = mapSize - 4;
      
      // Ensure starting locations are land
      for (let y = player1Y - 1; y <= player1Y + 1; y++) {
        for (let x = player1X - 1; x <= player1X + 1; x++) {
          if (x >= 0 && y >= 0 && x < mapSize && y < mapSize) {
            gameState.map[y][x].type = 'land';
          }
        }
      }
      
      for (let y = player2Y - 1; y <= player2Y + 1; y++) {
        for (let x = player2X - 1; x <= player2X + 1; x++) {
          if (x >= 0 && y >= 0 && x < mapSize && y < mapSize) {
            gameState.map[y][x].type = 'land';
          }
        }
      }
      
      // Place HQs
      gameState.map[player1Y][player1X].building = { type: 'hq', owner: 1 };
      gameState.map[player2Y][player2X].building = { type: 'hq', owner: 2 };
      
      // Add buildings to player lists
      gameState.players[0].buildings.push({ type: 'hq', x: player1X, y: player1Y });
      gameState.players[1].buildings.push({ type: 'hq', x: player2X, y: player2Y });
      
      // Reveal areas around HQs
      revealArea(player1X, player1Y, 4, 0);
      revealArea(player2X, player2Y, 4, 1);
    }
    
    // Reveal area around a point
    function revealArea(centerX, centerY, radius, playerIndex) {
      for (let y = centerY - radius; y <= centerY + radius; y++) {
        for (let x = centerX - radius; x <= centerX + radius; x++) {
          if (x >= 0 && y >= 0 && x < mapSize && y < mapSize) {
            const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            if (dist <= radius) {
              gameState.map[y][x].discovered[playerIndex] = true;
            }
          }
        }
      }
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // Canvas interactions
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('click', handleCanvasClick);
      canvas.addEventListener('contextmenu', e => e.preventDefault());
      
      // Map dragging
      canvas.addEventListener('mousedown', e => {
        if (e.button === 2) { // right mouse button
          isDragging = true;
          dragStartX = e.clientX;
          dragStartY = e.clientY;
        }
      });
      
      canvas.addEventListener('mouseup', e => {
        if (e.button === 2) {
          isDragging = false;
        }
      });
    }
    
    // Switch between tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // Update research and unit tabs
      if (tabName === 'research') {
        updateResearchButtons();
      } else if (tabName === 'units') {
        updateUnitButtons();
      }
    }
    
    // Toggle tech tree display
    function toggleTechTree() {
      const techTree = document.getElementById('techTree');
      if (techTree.style.display === 'block') {
        techTree.style.display = 'none';
      } else {
        renderTechTree();
        techTree.style.display = 'block';
      }
    }
    
    // Render tech tree visualization
    function renderTechTree() {
      const techTree = document.getElementById('techTree');
      const player = gameState.players[gameState.currentPlayer - 1];
      const ageData = technologies[player.age];
      
      let html = `<h4>${player.age} Technologies</h4><ul>`;
      
      for (const tech in ageData) {
        const techData = ageData[tech];
        const isResearched = player.technologies.includes(tech);
        const prereqsMet = techData.prerequisites.every(prereq => player.technologies.includes(prereq));
        
        html += `<li style="color: ${isResearched ? 'green' : (!prereqsMet ? 'gray' : 'black')}">
          ${tech} - Unlocks: ${techData.unlocks.join(', ')} ${isResearched ? '‚úì' : ''}
          ${techData.prerequisites.length > 0 ? `<br>Requires: ${techData.prerequisites.join(', ')}` : ''}
        </li>`;
      }
      
      html += '</ul>';
      techTree.innerHTML = html;
    }
    
    // Update research buttons based on current player age and technologies
    function updateResearchButtons() {
      const container = document.getElementById('researchButtons');
      container.innerHTML = '';
      
      const player = gameState.players[gameState.currentPlayer - 1];
      const ageData = technologies[player.age];
      
      if (!ageData) return;
      
      for (const tech in ageData) {
        const techData = ageData[tech];
        const isResearched = player.technologies.includes(tech);
        const prereqsMet = techData.prerequisites.every(prereq => player.technologies.includes(prereq));
        
        const button = document.createElement('button');
        button.textContent = `${tech} (${techData.cost} Gold)`;
        button.disabled = isResearched || !prereqsMet;
        button.title = techData.description;
        
        if (isResearched) {
          button.textContent += ' ‚úì';
          button.style.background = '#48BB78';
        } else if (!prereqsMet) {
          button.textContent += ' üîí';
        }
        
        button.onclick = () => startResearch(tech);
        container.appendChild(button);
      }
      
      // Update research progress bar
      const progressBar = document.getElementById('researchProgressBar');
      if (player.currentResearch) {
        progressBar.style.width = `${player.researchProgress}%`;
        document.getElementById('researchProgressLabel').textContent = 
          `Researching ${player.currentResearch}: ${Math.floor(player.researchProgress)}%`;
      } else {
        progressBar.style.width = '0%';
        document.getElementById('researchProgressLabel').textContent = 'No research in progress';
      }
    }
    
    // Start researching a technology
    function startResearch(techName) {
      const player = gameState.players[gameState.currentPlayer - 1];
      const tech = technologies[player.age][techName];
      
      if (player.resources.gold < tech.cost) {
        showNotification('Not enough gold for research');
        return;
      }
      
      player.resources.gold -= tech.cost;
      player.currentResearch = techName;
      player.researchProgress = 0;
      
      updateResourceDisplay();
      updateResearchButtons();
      showNotification(`Started research: ${techName}`);
    }
    
    // Complete research and unlock new units/buildings
    function completeResearch(playerIndex) {
      const player = gameState.players[playerIndex];
      
      if (!player.currentResearch) return;
      
      const tech = technologies[player.age][player.currentResearch];
      player.technologies.push(player.currentResearch);
      
      // Unlock new units
      tech.unlocks.forEach(unlock => {
        if (unitTypes[unlock] && !player.unlockedUnits.includes(unlock)) {
          player.unlockedUnits.push(unlock);
        }
      });
      
      showNotification(`${player.name} completed research: ${player.currentResearch}`);
      player.currentResearch = null;
      player.researchProgress = 0;
      
      updateResearchButtons();
      updateUnitButtons();
    }
    
    // Update unit production buttons
    function updateUnitButtons() {
      const container = document.getElementById('unitButtons');
      container.innerHTML = '';
      
      const player = gameState.players[gameState.currentPlayer - 1];
      const unlockedUnits = player.unlockedUnits;
      
      unlockedUnits.forEach(unitType => {
        if (!unitTypes[unitType]) return;
        
        const unit = unitTypes[unitType];
        const button = document.createElement('button');
        
        let costText = `${unit.cost.gold} Gold`;
        if (unit.cost.manpower) costText += `, ${unit.cost.manpower} Manpower`;
        if (unit.cost.oil) costText += `, ${unit.cost.oil} Oil`;
        
        button.textContent = `${unitType.charAt(0).toUpperCase() + unitType.slice(1)} (${costText})`;
        
        const canAfford = 
          player.resources.gold >= unit.cost.gold && 
          (!unit.cost.manpower || player.resources.manpower >= unit.cost.manpower) &&
          (!unit.cost.oil || player.resources.oil >= unit.cost.oil);
        
        button.disabled = !canAfford;
        button.onclick = () => createUnit(unitType);
        container.appendChild(button);
      });
    }
    
    // Create a new unit
    function createUnit(unitType) {
      const player = gameState.players[gameState.currentPlayer - 1];
      const unit = unitTypes[unitType];
      
      // Check if player can afford the unit
      if (
        player.resources.gold < unit.cost.gold || 
        (unit.cost.manpower && player.resources.manpower < unit.cost.manpower) ||
        (unit.cost.oil && player.resources.oil < unit.cost.oil)
      ) {
        showNotification('Not enough resources');
        return;
      }
      
      // Find valid position near HQ
      const hq = player.buildings.find(b => b.type === 'hq');
      if (!hq) {
        showNotification('No headquarters found');
        return;
      }
      
      // Look for empty tile around HQ
